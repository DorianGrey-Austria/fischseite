<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üêü Isolated Fish System Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(180deg, #87CEEB 0%, #4682B4 50%, #191970 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            color: white;
        }

        .test-info {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 1000;
        }

        .final-fish {
            position: fixed;
            font-size: 32px;
            cursor: pointer;
            user-select: none;
            transition: all 0.2s ease;
            will-change: transform;
            pointer-events: auto;
        }

        .final-fish:hover {
            transform: scale(1.15) !important;
            filter: drop-shadow(0 0 8px currentColor) !important;
            z-index: 999 !important;
        }

        .final-fish-fg {
            z-index: 150;
            opacity: 0.9;
        }

        .final-fish-bg {
            z-index: 50;
            opacity: 0.35;
            filter: brightness(0.7);
        }
    </style>
</head>
<body>
    <div class="test-info">
        <h3>üêü Fish System Test</h3>
        <p>Fish Count: <span id="fishCount">0</span></p>
        <p>Controls: Click = Spawn | Long Press = Remove</p>
        <button onclick="resetFish()">Reset</button>
        <button onclick="spawnTestFish()">Spawn Test</button>
    </div>

    <h1 style="text-align: center; margin-top: 100px;">üê† Click the fish to spawn more!</h1>
    <p style="text-align: center;">Long press to remove fish</p>

    <script>
        console.log('üêü Starting isolated fish test...');

        // Fish configuration
        const FISH_CONFIG = {
            'üê†': { flip: true, speed: 1.8, color: '#4ECDC4' },
            'üêü': { flip: true, speed: 2.1, color: '#FF6B6B' },
            'üê°': { flip: true, speed: 1.5, color: '#FFE66D' },
            'ü¶à': { flip: true, speed: 2.8, color: '#006994' },
            'üêô': { flip: false, speed: 1.3, color: '#8B5CF6' },
            'ü¶ê': { flip: false, speed: 2.3, color: '#FFA07A' },
            'ü¶û': { flip: false, speed: 1.0, color: '#DC2626' }
        };

        const FISH_EMOJIS = Object.keys(FISH_CONFIG);

        let fishSystem = {
            fishes: new Map(),
            fishId: 0,
            maxFishes: 15,
            animationId: null,
            longPressTimer: null
        };

        let lastTime = 0;

        function updateFishCount() {
            document.getElementById('fishCount').textContent = fishSystem.fishes.size;
        }

        function createFish(x, y, layer = 'fg') {
            if (fishSystem.fishes.size >= fishSystem.maxFishes) {
                console.log('üêü Max fish limit reached');
                return null;
            }

            const emoji = FISH_EMOJIS[Math.floor(Math.random() * FISH_EMOJIS.length)];
            const config = FISH_CONFIG[emoji];
            const id = `fish-${++fishSystem.fishId}`;

            const fish = {
                id: id,
                emoji: emoji,
                x: Math.max(50, Math.min(x, window.innerWidth - 100)),
                y: Math.max(50, Math.min(y, window.innerHeight - 100)),
                baseY: y,
                speed: config.speed + (Math.random() - 0.5) * 0.3,
                color: config.color,
                layer: layer,
                age: 0,
                maxAge: layer === 'bg' ? 15000 : 25000, // Long life for testing
                element: null
            };

            // Create DOM element
            const el = document.createElement('div');
            el.className = `final-fish final-fish-${layer}`;
            el.dataset.fishId = id;
            el.innerHTML = emoji;

            // Apply styles
            const transform = config.flip ? 'scaleX(-1)' : 'scaleX(1)';
            el.style.cssText = `
                left: ${fish.x}px;
                top: ${fish.y}px;
                color: ${fish.color};
                transform: ${transform};
            `;

            fish.element = el;
            fishSystem.fishes.set(id, fish);
            document.body.appendChild(el);

            console.log(`üêü Created fish: ${emoji} (${layer}) at (${fish.x}, ${fish.y}) - Total: ${fishSystem.fishes.size}`);
            updateFishCount();
            return fish;
        }

        function removeFish(id) {
            const fish = fishSystem.fishes.get(id);
            if (fish && fish.element) {
                fish.element.remove();
                fishSystem.fishes.delete(id);
                console.log(`üêü Removed fish: ${id} - Remaining: ${fishSystem.fishes.size}`);
                updateFishCount();
            }
        }

        function updateFish(fish, deltaTime) {
            // Move right
            fish.x += fish.speed * (deltaTime / 16.67);

            // Swimming motion
            fish.y = fish.baseY + Math.sin(fish.age * 0.002) * 15;

            // Age
            fish.age += deltaTime;

            // Update position
            if (fish.element) {
                fish.element.style.left = fish.x + 'px';
                fish.element.style.top = fish.y + 'px';
            }

            // Remove when off-screen or too old
            const shouldRemove = fish.x > window.innerWidth + 50 || fish.age >= fish.maxAge;

            if (shouldRemove) {
                console.log(`üêü Fish ${fish.id} should be removed: x=${fish.x}, age=${fish.age}/${fish.maxAge}`);
            }

            return shouldRemove;
        }

        function animate(currentTime) {
            const deltaTime = Math.min(currentTime - lastTime, 50);
            lastTime = currentTime;

            const toRemove = [];
            for (const [id, fish] of fishSystem.fishes) {
                if (updateFish(fish, deltaTime)) {
                    toRemove.push(id);
                }
            }

            // Remove expired fish
            toRemove.forEach(id => {
                console.log(`üêü Animation removing fish: ${id}`);
                removeFish(id);
            });

            fishSystem.animationId = requestAnimationFrame(animate);
        }

        // Event handlers
        function handleMouseDown(e) {
            const fishEl = e.target.closest('.final-fish');
            if (!fishEl) return;

            e.preventDefault();
            e.stopPropagation();

            const fishId = fishEl.dataset.fishId;
            console.log(`üêü Mouse down on fish: ${fishId}`);

            // Start long press timer
            fishSystem.longPressTimer = setTimeout(() => {
                console.log(`üêü Long press triggered for fish: ${fishId}`);
                removeFish(fishId);
                fishSystem.longPressTimer = null;
            }, 500);
        }

        function handleMouseUp(e) {
            const fishEl = e.target.closest('.final-fish');
            if (!fishEl) return;

            console.log('üêü Mouse up on fish');

            // Clear long press timer
            if (fishSystem.longPressTimer) {
                clearTimeout(fishSystem.longPressTimer);
                fishSystem.longPressTimer = null;

                // Short click = spawn fish
                const layer = Math.random() < 0.6 ? 'fg' : 'bg';
                console.log(`üêü Short click - spawning new fish at (${e.clientX}, ${e.clientY})`);
                createFish(e.clientX, e.clientY, layer);
            }
        }

        // Public API
        window.resetFish = function() {
            console.log('üêü Resetting fish system...');
            fishSystem.fishes.forEach((fish, id) => removeFish(id));
            createFish(200, window.innerHeight * 0.4, 'fg');
        };

        window.spawnTestFish = function() {
            const x = 150 + Math.random() * 300;
            const y = 150 + Math.random() * 200;
            const layer = Math.random() < 0.5 ? 'fg' : 'bg';
            createFish(x, y, layer);
        };

        // Initialize
        function init() {
            console.log('üêü Initializing isolated fish system...');

            // Add event listeners
            document.addEventListener('mousedown', handleMouseDown);
            document.addEventListener('mouseup', handleMouseUp);

            // Create initial fish
            console.log('üêü Creating initial fish...');
            createFish(200, window.innerHeight * 0.4, 'fg');

            // Start animation
            console.log('üêü Starting animation...');
            fishSystem.animationId = requestAnimationFrame(animate);

            console.log('üêü Isolated fish system ready!');
        }

        // Start when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>